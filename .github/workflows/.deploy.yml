name: ðŸš€ Deploy via SSH in easyvente.shop

on:
  push:
    branches:
      - main # DÃ©clenche le workflow sur chaque push sur la branche main

jobs:
  tests:
    name: ðŸ§ª Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§© Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, xml, bcmath, pdo_mysql, pdo_sqlite, gd, zip
          coverage: none

      - name: ðŸ“ Copy .env
        run: |
          if [ -f .env.example ]; then
            cp .env.example .env
          else
            echo "âš ï¸ .env.example not found, creating minimal .env"
            cat > .env << 'EOF'
          APP_NAME=Laravel
          APP_ENV=testing
          APP_KEY=
          APP_DEBUG=true
          APP_URL=http://localhost

          LOG_CHANNEL=stack
          LOG_LEVEL=debug

          DB_CONNECTION=sqlite
          DB_DATABASE=:memory:

          CACHE_DRIVER=array
          SESSION_DRIVER=array
          QUEUE_CONNECTION=sync

          MAIL_MAILER=array
          EOF
          fi

      - name: ðŸ“ Create storage directories
        run: |
          mkdir -p storage/framework/{sessions,views,cache}
          mkdir -p storage/logs
          mkdir -p bootstrap/cache
          chmod -R 775 storage bootstrap/cache

      - name: ðŸ“¦ Install Composer Dependencies
        run: composer install --prefer-dist --no-interaction --no-progress

      - name: ðŸ”‘ Generate Application Key
        run: php artisan key:generate --ansi

      - name: ðŸ§ª Run PHPUnit Tests
        continue-on-error: true
        run: |
          if [ -f phpunit.xml ] || [ -f phpunit.xml.dist ]; then
            php artisan test || php vendor/bin/phpunit
          else
            echo "âš ï¸ No PHPUnit configuration found, skipping tests"
          fi

      - name: ðŸ” Run Static Analysis (PHPStan/Pint)
        continue-on-error: true
        run: |
          if [ -f vendor/bin/phpstan ]; then
            vendor/bin/phpstan analyse --no-progress || echo "âš ï¸ PHPStan check failed or not configured"
          fi
          if [ -f vendor/bin/pint ]; then
            vendor/bin/pint --test || echo "âš ï¸ Pint check failed or not configured"
          fi

  build-assets:
    name: ðŸ—ï¸ Build Frontend Assets
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: ðŸ§© Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, xml, bcmath, pdo_mysql, pdo_sqlite, gd, zip
          coverage: none

      - name: ðŸ“ Copy .env
        run: |
          if [ -f .env.example ]; then
            cp .env.example .env
          else
            echo "âš ï¸ .env.example not found, creating minimal .env"
            cat > .env << 'EOF'
          APP_NAME=Laravel
          APP_ENV=testing
          APP_KEY=
          APP_DEBUG=true
          APP_URL=http://localhost

          LOG_CHANNEL=stack
          LOG_LEVEL=debug

          DB_CONNECTION=sqlite
          DB_DATABASE=:memory:

          CACHE_DRIVER=array
          SESSION_DRIVER=array
          QUEUE_CONNECTION=sync

          MAIL_MAILER=array
          EOF
          fi

      - name: ðŸ“ Create storage directories
        run: |
          mkdir -p storage/framework/{sessions,views,cache}
          mkdir -p storage/logs
          mkdir -p bootstrap/cache
          chmod -R 775 storage bootstrap/cache

      - name: ðŸ“¦ Install Composer Dependencies
        run: composer install --prefer-dist --no-interaction --no-progress

      - name: ðŸ”‘ Generate Application Key
        run: php artisan key:generate --ansi

      - name: ðŸ” Check for package.json
        id: check_package
        run: |
          if [ -f package.json ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“¦ Setup Node.js
        if: steps.check_package.outputs.exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: ${{ hashFiles('package-lock.json') != '' && 'npm' || '' }}

      - name: ðŸ“¥ Install NPM Dependencies
        if: steps.check_package.outputs.exists == 'true'
        continue-on-error: true
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            echo "â„¹ï¸ No package-lock.json found, using npm install"
            npm install
          fi

      - name: ðŸ—ï¸ Build Assets
        if: steps.check_package.outputs.exists == 'true'
        continue-on-error: true
        run: |
          if grep -q "\"build\"" package.json || grep -q "\"prod\"" package.json; then
            npm run build || npm run prod || echo "âš ï¸ Build script not found or failed"
          else
            echo "âš ï¸ No build script found in package.json"
          fi

      - name: ðŸ“¤ Upload Built Assets
        if: steps.check_package.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: build-assets
          path: public/build/
          if-no-files-found: ignore
          retention-days: 1

  deploy:
    name: ðŸš€ Deploy to Production
    needs: [tests, build-assets]
    runs-on: ubuntu-latest
    if: success() # Ne dÃ©ploie que si les tests passent

    steps:
      - name: ðŸ§© Checkout code
        uses: actions/checkout@v4
        # RÃ©cupÃ¨re le code source du dÃ©pÃ´t

      - name: ðŸ“¥ Download Built Assets
        uses: actions/download-artifact@v4
        with:
          name: build-assets
          path: public/build/
        continue-on-error: true
        # TÃ©lÃ©charge les assets buildÃ©s depuis le job build-assets

      - name: âš™ï¸ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
        # Installe PHP 8.3 sur l'environnement GitHub Actions
      - name: ðŸ“ Create Laravel cache directories
        run: |
          mkdir -p bootstrap/cache
          mkdir -p storage/framework/cache/data
          mkdir -p storage/framework/sessions
          mkdir -p storage/framework/views
          mkdir -p storage/logs
          chmod -R 775 bootstrap/cache
          chmod -R 775 storage
        # CrÃ©e les dossiers nÃ©cessaires pour Laravel avant l'installation
      - name: ðŸ“¦ Install dependencies
        run: composer install --no-dev --optimize-autoloader
        # Installe les dÃ©pendances PHP sans les dÃ©pendances de dÃ©veloppement

      - name: ðŸš€ Deploy to Hostinger via SSH
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "./"
          target: ${{ secrets.DEPLOY_PATH }}
          rm: false
          overwrite: true
          strip_components: 0
        # TransfÃ¨re tous les fichiers du projet vers le serveur distant via SCP

      - name: ðŸ”§ Run artisan commands remotely
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}
            php artisan migrate:fresh --force
            php artisan db:seed --force
            php artisan key:generate
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan optimize:clear
        # ExÃ©cute des commandes Laravel sur le serveur distant (migrations, cache, etc.)

      - name: ðŸ“„ Setup root files for Hostinger
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}

            # Create proper index.php for root (not public folder)
            cat > index.php << 'PHPEOF'
            <?php

            use Illuminate\Http\Request;

            define('LARAVEL_START', microtime(true));

            // Determine if the application is in maintenance mode...
            if (file_exists($maintenance = __DIR__.'/storage/framework/maintenance.php')) {
                require $maintenance;
            }

            // Register the Composer autoloader...
            require __DIR__.'/vendor/autoload.php';

            // Bootstrap Laravel and handle the request...
            (require_once __DIR__.'/bootstrap/app.php')
                ->handleRequest(Request::capture());
            PHPEOF

            # Copy .htaccess if not exists
            [ -f .htaccess ] || cp public/.htaccess .htaccess

            # Copy robots.txt if not exists
            [ -f robots.txt ] || cp public/robots.txt robots.txt

            # Set correct permissions
            chmod 644 index.php .htaccess robots.txt
            chmod -R 755 storage bootstrap/cache
            chmod -R 644 storage/logs/*.log 2>/dev/null || true
        # Configure les fichiers racine pour Hostinger
