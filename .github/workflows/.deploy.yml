name: üöÄ Deploy via SSH in easyvente.shop

on:
  push:
    branches:
      - main # D√©clenche le workflow sur chaque push sur la branche main

jobs:
  tests:
    name: üß™ Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: üß© Checkout code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, xml, bcmath, pdo_mysql, pdo_sqlite, gd, zip
          coverage: none

      - name: üìù Copy .env
        run: |
          if [ -f .env.example ]; then
            cp .env.example .env
          else
            echo "‚ö†Ô∏è .env.example not found, creating minimal .env"
            echo "APP_ENV=testing" > .env
            echo "APP_KEY=" >> .env
          fi

      - name: ÔøΩ Create storage directories
        run: |
          mkdir -p storage/framework/{sessions,views,cache}
          mkdir -p storage/logs
          mkdir -p bootstrap/cache
          chmod -R 775 storage bootstrap/cache

      - name: ÔøΩüì¶ Install Composer Dependencies
        run: composer install --prefer-dist --no-interaction --no-progress

      - name: üîë Generate Application Key
        run: php artisan key:generate --ansi

      - name: üß™ Run PHPUnit Tests
        continue-on-error: true
        run: |
          if [ -f phpunit.xml ] || [ -f phpunit.xml.dist ]; then
            php artisan test || php vendor/bin/phpunit
          else
            echo "‚ö†Ô∏è No PHPUnit configuration found, skipping tests"
          fi

      - name: üîç Run Static Analysis (PHPStan/Pint)
        continue-on-error: true
        run: |
          if [ -f vendor/bin/phpstan ]; then
            vendor/bin/phpstan analyse --no-progress || echo "‚ö†Ô∏è PHPStan check failed or not configured"
          fi
          if [ -f vendor/bin/pint ]; then
            vendor/bin/pint --test || echo "‚ö†Ô∏è Pint check failed or not configured"
          fi

  build-assets:
    name: üèóÔ∏è Build Frontend Assets
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: üß© Checkout code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, xml, bcmath, pdo_mysql, pdo_sqlite, gd, zip
          coverage: none

      - name: üìù Copy .env
        run: |
          if [ -f .env.example ]; then
            cp .env.example .env
          else
            echo "‚ö†Ô∏è .env.example not found, creating minimal .env"
            echo "APP_ENV=testing" > .env
            echo "APP_KEY=" >> .env
          fi

      - name: ÔøΩ Create storage directories
        run: |
          mkdir -p storage/framework/{sessions,views,cache}
          mkdir -p storage/logs
          mkdir -p bootstrap/cache
          chmod -R 775 storage bootstrap/cache

      - name: ÔøΩüì¶ Install Composer Dependencies
        run: composer install --prefer-dist --no-interaction --no-progress

      - name: üîë Generate Application Key
        run: php artisan key:generate --ansi

      - name: üîç Check for package.json
        id: check_package
        run: |
          if [ -f package.json ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: üì¶ Setup Node.js
        if: steps.check_package.outputs.exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: ${{ hashFiles('package-lock.json') != '' && 'npm' || '' }}

      - name: üì• Install NPM Dependencies
        if: steps.check_package.outputs.exists == 'true'
        continue-on-error: true
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            echo "‚ÑπÔ∏è No package-lock.json found, using npm install"
            npm install
          fi

      - name: üèóÔ∏è Build Assets
        if: steps.check_package.outputs.exists == 'true'
        continue-on-error: true
        run: |
          if grep -q "\"build\"" package.json || grep -q "\"prod\"" package.json; then
            npm run build || npm run prod || echo "‚ö†Ô∏è Build script not found or failed"
          else
            echo "‚ö†Ô∏è No build script found in package.json"
          fi

      - name: üì§ Upload Built Assets
        if: steps.check_package.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: build-assets
          path: public/build/
          if-no-files-found: ignore
          retention-days: 1

  deploy:
    name: üöÄ Deploy to Production
    needs: [tests, build-assets]
    runs-on: ubuntu-latest
    if: success() # Ne d√©ploie que si les tests passent

    steps:
      - name: üß© Checkout code
        uses: actions/checkout@v4
        # R√©cup√®re le code source du d√©p√¥t

      - name: üì• Download Built Assets
        uses: actions/download-artifact@v4
        with:
          name: build-assets
          path: public/build/
        continue-on-error: true
        # T√©l√©charge les assets build√©s depuis le job build-assets

      - name: ‚öôÔ∏è Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
        # Installe PHP 8.3 sur l'environnement GitHub Actions
      - name: üìÅ Create Laravel cache directories
        run: |
          mkdir -p bootstrap/cache
          mkdir -p storage/framework/cache/data
          mkdir -p storage/framework/sessions
          mkdir -p storage/framework/views
          mkdir -p storage/logs
          chmod -R 775 bootstrap/cache
          chmod -R 775 storage
        # Cr√©e les dossiers n√©cessaires pour Laravel avant l'installation
      - name: ÔøΩ Install dependencies
        run: composer install --no-dev --optimize-autoloader
        # Installe les d√©pendances PHP sans les d√©pendances de d√©veloppement

      - name: üöÄ Deploy to Hostinger via SSH
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "./"
          target: ${{ secrets.DEPLOY_PATH }}
          rm: false
          overwrite: true
          strip_components: 0
        # Transf√®re tous les fichiers du projet vers le serveur distant via SCP

      - name: üîß Run artisan commands remotely
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}
            php artisan migrate --force
            php artisan db:seed --force
            php artisan key:generate
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan optimize:clear
        # Ex√©cute des commandes Laravel sur le serveur distant (migrations, cache, etc.)

      - name: üìÑ Copy index.php, .htaccess and robots.txt to root
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            [ -f ${{ secrets.DEPLOY_PATH }}/index.php ] || cp ${{ secrets.DEPLOY_PATH }}/public/index.php ${{ secrets.DEPLOY_PATH }}/index.php
            [ -f ${{ secrets.DEPLOY_PATH }}/robots.txt ] || cp ${{ secrets.DEPLOY_PATH }}/public/robots.txt ${{ secrets.DEPLOY_PATH }}/robots.txt
            [ -f ${{ secrets.DEPLOY_PATH }}/.htaccess ] || cp ${{ secrets.DEPLOY_PATH }}/public/.htaccess ${{ secrets.DEPLOY_PATH }}/.htaccess
        # Copie certains fichiers du dossier public √† la racine si besoin
